<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>US Liquidity Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #0d1117;
            color: #e6e6e6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.5;
            padding: 1.5rem 1.5rem 3rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* ── Header ── */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        h1 { font-size: 1.4rem; font-weight: 600; color: #f0f6fc; }
        .subtitle { color: #8b949e; font-size: 0.8rem; margin-top: 0.1rem; }
        .updated { color: #484f58; font-size: 0.72rem; text-align: right; }

        /* ── Regime badge ── */
        .regime {
            display: inline-block;
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0.25rem 0.7rem;
            border-radius: 20px;
            margin-top: 0.35rem;
        }
        .regime.expanding   { background: rgba(63,185,80,0.15); color: #3fb950; border: 1px solid rgba(63,185,80,0.3); }
        .regime.contracting { background: rgba(248,81,73,0.15); color: #f85149; border: 1px solid rgba(248,81,73,0.3); }
        .regime.neutral     { background: rgba(139,148,158,0.15); color: #8b949e; border: 1px solid rgba(139,148,158,0.3); }

        /* ── Summary cards ── */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 8px;
            padding: 0.75rem 0.85rem;
        }
        .card-label {
            font-size: 0.68rem;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        .card-value {
            font-size: 1.15rem;
            font-weight: 600;
            color: #f0f6fc;
            font-family: "SF Mono", "Fira Code", monospace;
        }
        .card-sub {
            font-size: 0.72rem;
            margin-top: 0.15rem;
            font-family: "SF Mono", "Fira Code", monospace;
        }
        .pos { color: #3fb950; }
        .neg { color: #f85149; }
        .na  { color: #484f58; }

        /* ── Chart ── */
        .chart-section {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.25rem;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .chart-title { font-size: 0.9rem; font-weight: 600; color: #f0f6fc; }
        .chart-legend {
            display: flex;
            gap: 1rem;
            font-size: 0.72rem;
            color: #8b949e;
        }
        .legend-dot {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
        }
        .range-btns {
            display: flex;
            gap: 0.3rem;
        }
        .range-btn, .toggle-btn {
            background: #21262d;
            color: #8b949e;
            border: 1px solid #30363d;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.72rem;
            transition: all 0.15s;
        }
        .range-btn:hover, .range-btn.active,
        .toggle-btn:hover, .toggle-btn.active {
            background: #30363d;
            color: #f0f6fc;
        }
        .toggle-btn .legend-dot {
            display: inline-block;
            width: 7px; height: 7px;
            border-radius: 50%;
            margin-right: 3px;
            vertical-align: middle;
        }
        .toggle-btn.off { opacity: 0.4; }
        .toggle-btn.off .legend-dot { background: #484f58 !important; }
        .chart-area { width: 100%; height: 370px; }
        .chart-area-sm { width: 100%; height: 240px; }

        /* ── Table ── */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.25rem;
            font-size: 0.82rem;
        }
        th {
            text-align: left;
            padding: 0.55rem 0.7rem;
            color: #58a6ff;
            font-weight: 600;
            border-bottom: 2px solid #21262d;
            white-space: nowrap;
        }
        th:not(:first-child) { text-align: right; }
        td {
            padding: 0.5rem 0.7rem;
            border-bottom: 1px solid #161b22;
            white-space: nowrap;
        }
        td:not(:first-child) {
            text-align: right;
            font-family: "SF Mono", "Fira Code", monospace;
            font-size: 0.8rem;
        }
        tr:hover { background: rgba(56, 139, 253, 0.04); }
        tr.separator td {
            border-top: 2px solid #30363d;
            padding-top: 0.65rem;
            font-weight: 600;
            color: #f0f6fc;
        }
        .date-col { color: #8b949e; }

        /* ── Explainer ── */
        details {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 8px;
            margin-bottom: 1.25rem;
        }
        summary {
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            color: #f0f6fc;
            user-select: none;
        }
        summary:hover { color: #58a6ff; }
        .explainer-content {
            padding: 0 1rem 1rem;
            font-size: 0.8rem;
            color: #c9d1d9;
            line-height: 1.7;
        }
        .explainer-content h3 {
            color: #58a6ff;
            font-size: 0.82rem;
            margin: 1rem 0 0.3rem;
        }
        .explainer-content h3:first-child { margin-top: 0; }
        .explainer-content p { margin-bottom: 0.5rem; }

        footer {
            color: #484f58;
            font-size: 0.7rem;
            text-align: center;
            padding-top: 0.5rem;
        }

        @media (max-width: 600px) {
            body { padding: 1rem 1rem 2rem; }
            .cards { grid-template-columns: repeat(2, 1fr); }
            .chart-area { height: 280px; }
            .chart-area-sm { height: 200px; }
            table { font-size: 0.73rem; }
            td, th { padding: 0.35rem 0.45rem; }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>US Liquidity Monitor</h1>
            <div class="subtitle">Source: FRED &amp; CoinGecko</div>
            <div id="regime-badge" class="regime"></div>
        </div>
        <div class="updated" id="updated"></div>
    </header>

    <!-- Summary Cards -->
    <div class="cards" id="cards"></div>

    <!-- Main Chart: Net Liquidity + Crypto Overlays -->
    <div class="chart-section">
        <div class="chart-header">
            <div>
                <span class="chart-title">Net Liquidity vs Crypto</span>
                <div style="display:flex;gap:0.35rem;margin-top:0.4rem;flex-wrap:wrap">
                    <button class="toggle-btn active" data-series="nl"><span class="legend-dot" style="background:#26a69a"></span>Net Liquidity</button>
                    <button class="toggle-btn active" data-series="btc"><span class="legend-dot" style="background:#f7931a"></span>BTC</button>
                    <button class="toggle-btn active" data-series="eth"><span class="legend-dot" style="background:#627eea"></span>ETH</button>
                    <button class="toggle-btn active" data-series="alts"><span class="legend-dot" style="background:#e6007a"></span>Altcoins (ex-BTC)</button>
                    <button class="toggle-btn active" data-series="ism"><span class="legend-dot" style="background:#f59e0b"></span>NFCI</button>
                </div>
            </div>
            <div class="range-btns" id="range-btns-main">
                <button class="range-btn" data-days="90">3M</button>
                <button class="range-btn" data-days="180">6M</button>
                <button class="range-btn" data-days="365">1Y</button>
                <button class="range-btn" data-days="730">2Y</button>
                <button class="range-btn active" data-days="0">5Y</button>
            </div>
        </div>
        <div class="chart-area" id="chart-main"></div>
    </div>

    <!-- Secondary Chart: Global Liquidity + Stablecoin -->
    <div class="chart-section">
        <div class="chart-header">
            <div>
                <span class="chart-title">Global Liquidity &amp; Stablecoin Supply</span>
                <div class="chart-legend">
                    <span><span class="legend-dot" style="background:#8b5cf6"></span>Fed + ECB (USD)</span>
                    <span><span class="legend-dot" style="background:#06b6d4"></span>Stablecoins (USDT+USDC)</span>
                </div>
            </div>
            <div class="range-btns" id="range-btns-secondary">
                <button class="range-btn" data-days="90">3M</button>
                <button class="range-btn" data-days="180">6M</button>
                <button class="range-btn" data-days="365">1Y</button>
                <button class="range-btn" data-days="730">2Y</button>
                <button class="range-btn active" data-days="0">5Y</button>
            </div>
        </div>
        <div class="chart-area-sm" id="chart-secondary"></div>
    </div>

    <!-- US Metrics Table -->
    <table>
        <thead>
            <tr><th>Metric</th><th>Latest</th><th>As Of</th><th>1W Chg</th><th>1M Chg</th></tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <!-- Explainer -->
    <details>
        <summary>What do these metrics mean?</summary>
        <div class="explainer-content">
            <h3>Fed Balance Sheet (WALCL)</h3>
            <p>The source of dollar liquidity. When the Fed buys bonds (QE), reserves flood the banking system and risk assets rally. When they shrink it (QT), liquidity drains. This is the single biggest driver of macro liquidity cycles and has been the dominant force behind crypto bull/bear markets since 2020.</p>

            <h3>Bank Reserves (WRESBAL)</h3>
            <p>Cash that banks hold at the Fed. When reserves are abundant, banks lend freely, funding is cheap, and leverage flows into risk assets. When reserves get scarce, funding markets tighten. Think of this as the fuel gauge for the financial plumbing that ultimately powers speculative asset prices.</p>

            <h3>Reverse Repos (RRPONTSYD)</h3>
            <p>Cash parked at the Fed by money market funds — effectively removed from the financial system. This peaked at ~$2.5T in 2022 and has now drained to nearly zero. That $2.5T flowing back into markets was a massive hidden tailwind for risk assets. Now that the tank is empty, that tailwind is gone.</p>

            <h3>Treasury General Account (TGA)</h3>
            <p>The government's checking account. When Treasury spends (TGA drops), cash enters the system — bullish. When Treasury issues bonds to refill it, cash leaves — bearish. Debt ceiling standoffs force the TGA to drain, which is why crypto often rallies during those episodes.</p>

            <h3>M2 Money Supply</h3>
            <p>The broadest measure of money in the economy. The 2020–2021 M2 explosion (+40%) powered the everything-rally including BTC to $69K. M2 contraction in 2022–2023 coincided with the bear market. Changes in M2 correlate with risk appetite on longer timeframes.</p>

            <h3>Net Liquidity</h3>
            <p>Fed Balance Sheet minus TGA minus Reverse Repos. This captures the net amount of Fed-created liquidity actually circulating in the financial system. It strips out the cash locked up in government accounts and Fed facilities. BTC has tracked this metric remarkably well since 2020 — when net liquidity rises, crypto tends to follow.</p>

            <h3>Global Liquidity (Fed + ECB)</h3>
            <p>Dollar liquidity doesn't exist in isolation. The ECB's balance sheet adds euro-denominated liquidity that flows into global markets. When major central banks expand in tandem, the effect on risk assets is amplified. The 2023 crypto rally was partly driven by BOJ/PBOC easing while the Fed was still tightening.</p>

            <h3>Stablecoin Supply (USDT + USDC)</h3>
            <p>Crypto's own liquidity proxy. Stablecoin market cap represents fiat capital sitting on-chain, ready to deploy into crypto. Sustained growth in stablecoin supply tends to precede or accompany crypto rallies, while contraction signals capital leaving the ecosystem.</p>

            <h3>Financial Conditions (NFCI)</h3>
            <p>The Chicago Fed National Financial Conditions Index measures the tightness or looseness of US financial conditions across money markets, debt, equity, and the banking system. Negative values mean conditions are looser than average — cheap funding, easy credit, high risk appetite. Positive values mean tighter conditions. For crypto, this is a direct measure of the environment: the more negative the NFCI, the more favorable the conditions for liquidity-sensitive risk assets. Rapid moves toward tighter conditions (rising NFCI) tend to coincide with risk-off episodes. Updated weekly.</p>

            <h3>Liquidity Impulse</h3>
            <p>The 30-day rate of change in net liquidity. For risk assets, direction matters more than level. A positive impulse means liquidity conditions are improving — historically a favorable setup for crypto. A negative impulse signals tightening conditions.</p>
        </div>
    </details>

    <footer>
        Data: FRED (Fed, weekly) &bull; CoinGecko (BTC/stablecoins, daily) &bull; Auto-updated daily via GitHub Actions
    </footer>

    <script src="https://unpkg.com/lightweight-charts@4/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        var DATA = __DATA_PLACEHOLDER__;

        // ── Helpers ──
        function fmtChg(v) {
            if (v === null || v === undefined) return '\u2014';
            return (v >= 0 ? '+' : '') + v.toFixed(1) + 'B';
        }
        function chgClass(v) {
            if (v === null || v === undefined) return 'na';
            return v >= 0 ? 'pos' : 'neg';
        }
        function fmtPct(v) {
            if (v === null || v === undefined) return '';
            return (v >= 0 ? '+' : '') + v.toFixed(1) + '%';
        }
        function fmtUsd(v) {
            if (v >= 1e6) return '$' + (v/1e6).toFixed(0) + 'M';
            if (v >= 1e3) return '$' + (v/1e3).toFixed(0) + 'K';
            return '$' + v.toFixed(0);
        }

        // ── Regime badge ──
        var regimeBadge = document.getElementById('regime-badge');
        var regimeLabels = { expanding: 'Expanding', contracting: 'Contracting', neutral: 'Neutral' };
        var regimeDots   = { expanding: '\u25B2', contracting: '\u25BC', neutral: '\u25CF' };
        regimeBadge.className = 'regime ' + DATA.regime;
        regimeBadge.textContent = regimeDots[DATA.regime] + ' Liquidity ' + regimeLabels[DATA.regime];

        document.getElementById('updated').textContent = 'Updated: ' + DATA.generated_at;

        // ── Summary cards ──
        var cardsHtml = '';
        var s = DATA.summary;

        if (s.net_liquidity !== undefined) {
            var impClass = (DATA.impulse && DATA.impulse.change_billions >= 0) ? 'pos' : 'neg';
            var impVal = DATA.impulse ? ((DATA.impulse.change_billions >= 0 ? '+' : '') + DATA.impulse.change_billions.toFixed(0) + 'B / ' + fmtPct(DATA.impulse.change_pct)) : '\u2014';
            cardsHtml += '<div class="card"><div class="card-label">Net Liquidity</div><div class="card-value">$' + s.net_liquidity.toFixed(2) + 'T</div><div class="card-sub ' + impClass + '">30d: ' + impVal + '</div></div>';
        }
        if (s.btc_price !== undefined) {
            var btcChg = s.btc_30d_pct !== undefined ? fmtPct(s.btc_30d_pct) : '\u2014';
            var btcClass = (s.btc_30d_pct !== undefined && s.btc_30d_pct >= 0) ? 'pos' : 'neg';
            cardsHtml += '<div class="card"><div class="card-label">Bitcoin</div><div class="card-value">' + fmtUsd(s.btc_price) + '</div><div class="card-sub ' + btcClass + '">30d: ' + btcChg + '</div></div>';
        }
        if (s.eth_price !== undefined) {
            var ethChg = s.eth_30d_pct !== undefined ? fmtPct(s.eth_30d_pct) : '\u2014';
            var ethClass = (s.eth_30d_pct !== undefined && s.eth_30d_pct >= 0) ? 'pos' : 'neg';
            cardsHtml += '<div class="card"><div class="card-label">Ethereum</div><div class="card-value">' + fmtUsd(s.eth_price) + '</div><div class="card-sub ' + ethClass + '">30d: ' + ethChg + '</div></div>';
        }
        if (s.altcoin_mcap !== undefined) {
            var altChg = s.altcoin_30d_pct !== undefined ? fmtPct(s.altcoin_30d_pct) : '\u2014';
            var altClass = (s.altcoin_30d_pct !== undefined && s.altcoin_30d_pct >= 0) ? 'pos' : 'neg';
            cardsHtml += '<div class="card"><div class="card-label">Altcoins (ex-BTC)</div><div class="card-value">$' + s.altcoin_mcap.toFixed(0) + 'B</div><div class="card-sub ' + altClass + '">30d: ' + altChg + '</div></div>';
        }
        if (s.global_liquidity !== undefined) {
            var glChg = s.global_30d_pct !== undefined ? fmtPct(s.global_30d_pct) : '\u2014';
            var glClass = (s.global_30d_pct !== undefined && s.global_30d_pct >= 0) ? 'pos' : 'neg';
            cardsHtml += '<div class="card"><div class="card-label">Global Liquidity</div><div class="card-value">$' + s.global_liquidity.toFixed(1) + 'T</div><div class="card-sub ' + glClass + '">30d: ' + glChg + '</div></div>';
        }
        if (s.stablecoin_total !== undefined) {
            var stChg = s.stablecoin_30d_change !== undefined ? ((s.stablecoin_30d_change >= 0 ? '+' : '') + s.stablecoin_30d_change.toFixed(1) + 'B') : '\u2014';
            var stClass = (s.stablecoin_30d_change !== undefined && s.stablecoin_30d_change >= 0) ? 'pos' : 'neg';
            cardsHtml += '<div class="card"><div class="card-label">Stablecoin Supply</div><div class="card-value">$' + s.stablecoin_total.toFixed(0) + 'B</div><div class="card-sub ' + stClass + '">30d: ' + stChg + '</div></div>';
        }
        if (s.ism !== undefined) {
            var nfciLoose = s.ism < 0;
            var nfciClass = nfciLoose ? 'pos' : 'neg';
            var nfciLabel = nfciLoose ? 'Loose' : 'Tight';
            var nfciChgStr = s.ism_change !== undefined ? ((s.ism_change >= 0 ? '+' : '') + s.ism_change.toFixed(2)) : '\u2014';
            var nfciChgClass = (s.ism_change !== undefined && s.ism_change <= 0) ? 'pos' : 'neg';
            cardsHtml += '<div class="card"><div class="card-label">Financial Conditions</div><div class="card-value">' + s.ism.toFixed(2) + '</div><div class="card-sub ' + nfciClass + '">' + nfciLabel + ' <span class="' + nfciChgClass + '">(' + nfciChgStr + ')</span></div></div>';
        }
        if (DATA.impulse) {
            var impulseClass = DATA.impulse.change_billions >= 0 ? 'pos' : 'neg';
            var impulseArrow = DATA.impulse.change_billions >= 0 ? '\u25B2' : '\u25BC';
            cardsHtml += '<div class="card"><div class="card-label">Liquidity Impulse</div><div class="card-value ' + impulseClass + '">' + impulseArrow + ' ' + fmtPct(DATA.impulse.change_pct) + '</div><div class="card-sub ' + impulseClass + '">30d: ' + (DATA.impulse.change_billions >= 0 ? '+' : '') + DATA.impulse.change_billions.toFixed(0) + 'B</div></div>';
        }

        document.getElementById('cards').innerHTML = cardsHtml;

        // ── Table ──
        var tHtml = '';
        for (var i = 0; i < DATA.table.length; i++) {
            var r = DATA.table[i];
            var cls = r.series_id === 'NET_LIQUIDITY' ? ' class="separator"' : '';
            tHtml += '<tr' + cls + '>';
            tHtml += '<td>' + r.label + '</td>';
            tHtml += '<td>$' + r.current.toFixed(3) + 'T</td>';
            tHtml += '<td class="date-col">' + r.current_date + '</td>';
            tHtml += '<td class="' + chgClass(r.week_change) + '">' + fmtChg(r.week_change) + '</td>';
            tHtml += '<td class="' + chgClass(r.month_change) + '">' + fmtChg(r.month_change) + '</td>';
            tHtml += '</tr>';
        }
        document.getElementById('table-body').innerHTML = tHtml;

        // ── Charts ──
        function makeChartOptions(containerId) {
            return {
                height: document.getElementById(containerId).clientHeight,
                layout: { background: { color: '#161b22' }, textColor: '#8b949e', fontSize: 11 },
                grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                timeScale: { borderColor: '#30363d', timeVisible: false, rightOffset: 5 },
                rightPriceScale: { borderColor: '#30363d' },
                leftPriceScale: { visible: true, borderColor: '#30363d' },
            };
        }

        function toChartPoints(arr) {
            return arr.map(function(p) { return { time: p.date, value: p.value }; });
        }

        function setRange(chart, days) {
            if (days === 0) {
                chart.timeScale().fitContent();
            } else {
                var now = new Date();
                var from = new Date(now.getTime() - days * 86400000);
                var fromStr = from.toISOString().slice(0, 10);
                var toStr = now.toISOString().slice(0, 10);
                chart.timeScale().setVisibleRange({ from: fromStr, to: toStr });
            }
        }

        function bindRangeButtons(btnContainerId, chart) {
            var btns = document.querySelectorAll('#' + btnContainerId + ' .range-btn');
            btns.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    btns.forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');
                    setRange(chart, parseInt(btn.dataset.days));
                });
            });
        }

        // ── Main chart: Net Liquidity + crypto overlays with toggles ──
        var mainContainer = document.getElementById('chart-main');
        var mainChart = LightweightCharts.createChart(mainContainer, makeChartOptions('chart-main'));

        // Track all series for toggle logic
        var mainSeries = {};

        // Net Liquidity (left axis)
        mainSeries.nl = mainChart.addAreaSeries({
            topColor: 'rgba(38, 166, 154, 0.3)',
            bottomColor: 'rgba(38, 166, 154, 0.0)',
            lineColor: '#26a69a',
            lineWidth: 2,
            priceScaleId: 'left',
            priceFormat: { type: 'custom', formatter: function(p) { return '$' + p.toFixed(2) + 'T'; } },
        });
        mainSeries.nl.setData(toChartPoints(DATA.chart_net_liq));

        // BTC (right axis, visible)
        if (DATA.chart_btc && DATA.chart_btc.length > 0) {
            mainSeries.btc = mainChart.addLineSeries({
                color: '#f7931a',
                lineWidth: 2,
                priceScaleId: 'right',
                priceFormat: { type: 'custom', formatter: function(p) { return '$' + Math.round(p).toLocaleString(); } },
            });
            mainSeries.btc.setData(toChartPoints(DATA.chart_btc));
        }

        // ETH (own hidden axis so it auto-scales independently)
        if (DATA.chart_eth && DATA.chart_eth.length > 0) {
            mainSeries.eth = mainChart.addLineSeries({
                color: '#627eea',
                lineWidth: 2,
                priceScaleId: 'eth-scale',
                priceFormat: { type: 'custom', formatter: function(p) { return '$' + Math.round(p).toLocaleString(); } },
            });
            mainSeries.eth.setData(toChartPoints(DATA.chart_eth));
            mainChart.priceScale('eth-scale').applyOptions({ visible: false });
        }

        // Altcoins — ETH mcap as proxy (own hidden axis, in $B)
        if (DATA.chart_altcoins && DATA.chart_altcoins.length > 0) {
            mainSeries.alts = mainChart.addLineSeries({
                color: '#e6007a',
                lineWidth: 2,
                priceScaleId: 'alts-scale',
                priceFormat: { type: 'custom', formatter: function(p) { return '$' + p.toFixed(0) + 'B'; } },
            });
            mainSeries.alts.setData(toChartPoints(DATA.chart_altcoins));
            mainChart.priceScale('alts-scale').applyOptions({ visible: false });
        }

        // NFCI Financial Conditions (own hidden axis, typically -1.0 to +1.0)
        if (DATA.chart_ism && DATA.chart_ism.length > 0) {
            mainSeries.ism = mainChart.addLineSeries({
                color: '#f59e0b',
                lineWidth: 2,
                lineStyle: 2,
                priceScaleId: 'ism-scale',
                priceFormat: { type: 'custom', formatter: function(p) { return 'NFCI ' + p.toFixed(2); } },
            });
            mainSeries.ism.setData(toChartPoints(DATA.chart_ism));
            mainChart.priceScale('ism-scale').applyOptions({ visible: false });
        }

        mainChart.timeScale().fitContent();
        bindRangeButtons('range-btns-main', mainChart);
        new ResizeObserver(function() {
            mainChart.applyOptions({ width: mainContainer.clientWidth });
        }).observe(mainContainer);

        // ── Toggle buttons ──
        // Store original data so we can restore on re-toggle
        var seriesData = {
            nl: toChartPoints(DATA.chart_net_liq),
            btc: DATA.chart_btc ? toChartPoints(DATA.chart_btc) : [],
            eth: DATA.chart_eth ? toChartPoints(DATA.chart_eth) : [],
            alts: DATA.chart_altcoins ? toChartPoints(DATA.chart_altcoins) : [],
            ism: DATA.chart_ism ? toChartPoints(DATA.chart_ism) : [],
        };

        document.querySelectorAll('.toggle-btn[data-series]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var key = btn.dataset.series;
                var series = mainSeries[key];
                if (!series) return;

                var isActive = btn.classList.contains('active');
                if (isActive) {
                    // Hide: set empty data
                    series.setData([]);
                    btn.classList.remove('active');
                    btn.classList.add('off');
                } else {
                    // Show: restore data
                    series.setData(seriesData[key]);
                    btn.classList.add('active');
                    btn.classList.remove('off');
                }
            });
        });

        // ── Secondary chart: Global Liquidity (left) + Stablecoin (right) ──
        var secContainer = document.getElementById('chart-secondary');
        var secChart = LightweightCharts.createChart(secContainer, makeChartOptions('chart-secondary'));

        if (DATA.chart_global_liq && DATA.chart_global_liq.length > 0) {
            var glSeries = secChart.addAreaSeries({
                topColor: 'rgba(139, 92, 246, 0.3)',
                bottomColor: 'rgba(139, 92, 246, 0.0)',
                lineColor: '#8b5cf6',
                lineWidth: 2,
                priceScaleId: 'left',
                priceFormat: { type: 'custom', formatter: function(p) { return '$' + p.toFixed(1) + 'T'; } },
            });
            glSeries.setData(toChartPoints(DATA.chart_global_liq));
        }

        if (DATA.chart_stablecoin && DATA.chart_stablecoin.length > 0) {
            var stSeries = secChart.addLineSeries({
                color: '#06b6d4',
                lineWidth: 2,
                priceScaleId: 'right',
                priceFormat: { type: 'custom', formatter: function(p) { return '$' + p.toFixed(0) + 'B'; } },
            });
            stSeries.setData(toChartPoints(DATA.chart_stablecoin));
        }

        secChart.timeScale().fitContent();
        bindRangeButtons('range-btns-secondary', secChart);
        new ResizeObserver(function() {
            secChart.applyOptions({ width: secContainer.clientWidth });
        }).observe(secContainer);
    </script>
</body>
</html>
